<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TyrexCAD Professional v3.0 - Advanced CAD System with Phase 1 Tools</title>
    <!-- Font Awesome for Professional Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    <script>window.addEventListener('error',e=>{if(e.message&&(e.message.includes('export')||e.message.includes('import')||e.message.includes('ctx.save')))e.preventDefault()});</script>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">T</div>
    </div>
    
    <!-- Application Header -->
    <header class="app-header">
        <div class="app-branding">
            <div class="app-logo">T</div>
            <div>
                <div class="app-title">TyrexCAD Professional</div>
                <div class="app-version">Version 3.0 - Phase 1 Complete</div>
            </div>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <button class="btn" onclick="newFile()"><i class="fas fa-file"></i> New</button>
            <button class="btn" onclick="openFile()"><i class="fas fa-folder-open"></i> Open</button>
            <button class="btn" onclick="saveFile()"><i class="fas fa-save"></i> Save</button>
            <button class="btn" onclick="exportFile()"><i class="fas fa-file-export"></i> Export</button>
        </div>
    </header>
    
    <!-- Ribbon Interface -->
    <div class="ribbon-container">
        <div class="ribbon-tabs">
            <div class="ribbon-tab active" onclick="showRibbon('draw')">Draw</div>
            <div class="ribbon-tab" onclick="showRibbon('modify')">Modify</div>
            <div class="ribbon-tab" onclick="showRibbon('annotate')">Annotate</div>
            <div class="ribbon-tab" onclick="showRibbon('view')">View</div>
            <div class="ribbon-tab" onclick="showRibbon('tools')">Tools</div>
            <div class="ribbon-tab" onclick="showRibbon('3d')">3D</div>
        </div>
        
        <!-- Draw Ribbon -->
        <div class="ribbon-content active" id="ribbon-draw">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Lines</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('line')" title="Draw Line (L)">
                        <div class="ribbon-tool-icon"><i class="fas fa-slash"></i></div>
                        <div class="ribbon-tool-label">Line</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('polyline')" title="Draw Polyline (PL)">
                        <div class="ribbon-tool-icon"><i class="fas fa-route"></i></div>
                        <div class="ribbon-tool-label">Polyline</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Shapes</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('rectangle')" title="Draw Rectangle (REC)">
                        <div class="ribbon-tool-icon"><i class="far fa-square"></i></div>
                        <div class="ribbon-tool-label">Rectangle</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('circle')" title="Draw Circle (C)">
                        <div class="ribbon-tool-icon"><i class="far fa-circle"></i></div>
                        <div class="ribbon-tool-label">Circle</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('arc')" title="Draw Arc (A)">
                        <div class="ribbon-tool-icon"><i class="fas fa-bezier-curve"></i></div>
                        <div class="ribbon-tool-label">Arc</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('ellipse')" title="Draw Ellipse (EL)">
                        <div class="ribbon-tool-icon"><i class="fas fa-egg"></i></div>
                        <div class="ribbon-tool-label">Ellipse</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('polygon')" title="Draw Polygon (POL)">
                        <div class="ribbon-tool-icon"><i class="fas fa-draw-polygon"></i></div>
                        <div class="ribbon-tool-label">Polygon</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Drawing Settings</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="window.cad && window.cad.ui && window.cad.ui.showLinetypePanel && window.cad.ui.showLinetypePanel()" title="Line Type">
                        <div class="ribbon-tool-icon">
                            <svg width="30" height="20" style="vertical-align: middle;">
                                <line x1="5" y1="10" x2="25" y2="10" stroke="currentColor" stroke-width="2" id="ribbonLinetypeDisplay"/>
                            </svg>
                        </div>
                        <div class="ribbon-tool-label">Line Type</div>
                    </div>
                    <div class="ribbon-tool" onclick="window.cad && window.cad.ui && window.cad.ui.showLineWeightPanel && window.cad.ui.showLineWeightPanel()" title="Line Weight">
                        <div class="ribbon-tool-icon"><i class="fas fa-weight"></i></div>
                        <div class="ribbon-tool-label">Weight</div>
                    </div>
                    <div class="ribbon-tool" onclick="toggleColorDropdown()" title="Color">
                        <div class="ribbon-tool-icon">
                            <div style="width: 24px; height: 24px; border-radius: 4px; background: var(--accent-primary); border: 2px solid var(--border-color);"></div>
                        </div>
                        <div class="ribbon-tool-label">Color</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Layers</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="window.cad && window.cad.ui && window.cad.ui.showLayerManager && window.cad.ui.showLayerManager()" title="Layer Manager">
                        <div class="ribbon-tool-icon"><i class="fas fa-layer-group"></i></div>
                        <div class="ribbon-tool-label">Manager</div>
                    </div>
                    <div class="ribbon-tool" onclick="window.cad && window.cad.matchLayer && window.cad.matchLayer()" title="Match Layer">
                        <div class="ribbon-tool-icon"><i class="fas fa-eyedropper"></i></div>
                        <div class="ribbon-tool-label">Match</div>
                    </div>
                    <div class="ribbon-tool" onclick="window.cad && window.cad.ui && window.cad.ui.showLayerStatesDialog && window.cad.ui.showLayerStatesDialog()" title="Layer States">
                        <div class="ribbon-tool-icon"><i class="fas fa-save"></i></div>
                        <div class="ribbon-tool-label">States</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 🔧 Modify Ribbon - Updated with Phase 1 Tools -->
        <div class="ribbon-content" id="ribbon-modify">
            <!-- Transform Group -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Transform</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('move')" title="Move Objects (M)">
                        <div class="ribbon-tool-icon"><i class="fas fa-arrows-alt"></i></div>
                        <div class="ribbon-tool-label">Move</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('copy')" title="Copy Objects (CO)">
                        <div class="ribbon-tool-icon"><i class="fas fa-copy"></i></div>
                        <div class="ribbon-tool-label">Copy</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('rotate')" title="Rotate Objects (RO)">
                        <div class="ribbon-tool-icon"><i class="fas fa-sync-alt"></i></div>
                        <div class="ribbon-tool-label">Rotate</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('scale')" title="Scale Objects (SC)">
                        <div class="ribbon-tool-icon"><i class="fas fa-expand-arrows-alt"></i></div>
                        <div class="ribbon-tool-label">Scale</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('mirror')" title="Mirror Objects (MI)">
                        <div class="ribbon-tool-icon"><i class="fas fa-object-ungroup"></i></div>
                        <div class="ribbon-tool-label">Mirror</div>
                    </div>
                </div>
            </div>
            
            <!-- Edit Group - Updated with Stretch -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Edit</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('trim')" title="Trim Objects (TR)">
                        <div class="ribbon-tool-icon"><i class="fas fa-cut"></i></div>
                        <div class="ribbon-tool-label">Trim</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('extend')" title="Extend Objects (EX)">
                        <div class="ribbon-tool-icon"><i class="fas fa-expand"></i></div>
                        <div class="ribbon-tool-label">Extend</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('offset')" title="Offset Objects (O)">
                        <div class="ribbon-tool-icon"><i class="fas fa-clone"></i></div>
                        <div class="ribbon-tool-label">Offset</div>
                    </div>
                    <!-- 🆕 Phase 1: Stretch Tool -->
                    <div class="ribbon-tool" onclick="setTool('stretch')" title="Stretch Objects (Shift+S)">
                        <div class="ribbon-tool-icon"><i class="fas fa-arrows-alt-h"></i></div>
                        <div class="ribbon-tool-label">Stretch</div>
                    </div>
                </div>
            </div>
            
            <!-- 🆕 Phase 1: Break Tools Group -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Break</div>
                <div class="ribbon-group-content">
                    <!-- 🆕 Break Tool -->
                    <div class="ribbon-tool" onclick="setTool('break')" title="Break Objects Between Two Points (B)">
                        <div class="ribbon-tool-icon"><i class="fas fa-cut"></i></div>
                        <div class="ribbon-tool-label">Break</div>
                    </div>
                    <!-- 🆕 Break at Point Tool -->
                    <div class="ribbon-tool" onclick="setTool('break-at-point')" title="Break Objects at Single Point (Shift+B)">
                        <div class="ribbon-tool-icon"><i class="fas fa-crosshairs"></i></div>
                        <div class="ribbon-tool-label">Break@Pt</div>
                    </div>
                </div>
            </div>
            
            <!-- Advanced Tools Group -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Advanced</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('fillet')" title="Fillet (F)">
                        <div class="ribbon-tool-icon"><i class="fas fa-bezier-curve"></i></div>
                        <div class="ribbon-tool-label">Fillet</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('chamfer')" title="Chamfer (CHA)">
                        <div class="ribbon-tool-icon"><i class="fas fa-slash"></i></div>
                        <div class="ribbon-tool-label">Chamfer</div>
                    </div>
                </div>
            </div>
            
            <!-- Array Tools Group -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Array</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('rectangular-array')" title="Rectangular Array (AR)">
                        <div class="ribbon-tool-icon"><i class="fas fa-th"></i></div>
                        <div class="ribbon-tool-label">Rect Array</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('polar-array')" title="Polar Array">
                        <div class="ribbon-tool-icon"><i class="fas fa-circle-notch"></i></div>
                        <div class="ribbon-tool-label">Polar Array</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('path-array')" title="Path Array">
                        <div class="ribbon-tool-icon"><i class="fas fa-route"></i></div>
                        <div class="ribbon-tool-label">Path Array</div>
                    </div>
                </div>
            </div>
            
            <!-- Boolean Operations Group -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Boolean</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="activateTool('union')" title="Union (UNI)">
                        <div class="ribbon-tool-icon"><i class="fas fa-plus-circle"></i></div>
                        <div class="ribbon-tool-label">Union</div>
                    </div>
                    <div class="ribbon-tool" onclick="activateTool('difference')" title="Difference (DIF)">
                        <div class="ribbon-tool-icon"><i class="fas fa-minus-circle"></i></div>
                        <div class="ribbon-tool-label">Difference</div>
                    </div>
                    <div class="ribbon-tool" onclick="activateTool('intersection')" title="Intersection (INT)">
                        <div class="ribbon-tool-icon"><i class="fas fa-circle"></i></div>
                        <div class="ribbon-tool-label">Intersection</div>
                    </div>
                </div>
            </div>
            
            <!-- Analysis Tools Group -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Analysis</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="activateTool('distance-analysis')" title="Distance (DIST)">
                        <div class="ribbon-tool-icon"><i class="fas fa-ruler"></i></div>
                        <div class="ribbon-tool-label">Distance</div>
                    </div>
                    <div class="ribbon-tool" onclick="activateTool('area-analysis')" title="Area (AREA)">
                        <div class="ribbon-tool-icon"><i class="fas fa-vector-square"></i></div>
                        <div class="ribbon-tool-label">Area</div>
                    </div>
                    <div class="ribbon-tool" onclick="activateTool('properties-analysis')" title="Properties (PROP)">
                        <div class="ribbon-tool-icon"><i class="fas fa-info-circle"></i></div>
                        <div class="ribbon-tool-label">Properties</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Annotate Ribbon -->
        <div class="ribbon-content" id="ribbon-annotate">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Text & Dimensions</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('text')" title="Add Text (T)">
                        <div class="ribbon-tool-icon"><i class="fas fa-text-height"></i></div>
                        <div class="ribbon-tool-label">Text</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension')" title="Linear Dimension (DLI)">
                        <div class="ribbon-tool-icon"><i class="fas fa-ruler-horizontal"></i></div>
                        <div class="ribbon-tool-label">Linear</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension-angular')" title="Angular Dimension (DAN)">
                        <div class="ribbon-tool-icon"><i class="fas fa-drafting-compass"></i></div>
                        <div class="ribbon-tool-label">Angular</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension-radius')" title="Radius Dimension (DRA)">
                        <div class="ribbon-tool-icon"><i class="fas fa-circle-notch"></i></div>
                        <div class="ribbon-tool-label">Radius</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension-diameter')" title="Diameter Dimension (DDI)">
                        <div class="ribbon-tool-icon"><i class="fas fa-circle"></i></div>
                        <div class="ribbon-tool-label">Diameter</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- View Ribbon -->
        <div class="ribbon-content" id="ribbon-view">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Navigation</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('pan')" title="Pan View (P)">
                        <div class="ribbon-tool-icon"><i class="fas fa-hand-paper"></i></div>
                        <div class="ribbon-tool-label">Pan</div>
                    </div>
                    <div class="ribbon-tool" onclick="zoomExtents()" title="Zoom Extents (Z E)">
                        <div class="ribbon-tool-icon"><i class="fas fa-compress-arrows-alt"></i></div>
                        <div class="ribbon-tool-label">Zoom All</div>
                    </div>
                    <div class="ribbon-tool" onclick="zoomWindow()" title="Zoom Window (Z W)">
                        <div class="ribbon-tool-icon"><i class="fas fa-search-plus"></i></div>
                        <div class="ribbon-tool-label">Zoom Window</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tools Ribbon -->
        <div class="ribbon-content" id="ribbon-tools">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Selection</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool active" onclick="setTool('select')" title="Select Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-mouse-pointer"></i></div>
                        <div class="ribbon-tool-label">Select</div>
                    </div>
                    <div class="ribbon-tool" onclick="selectAll()" title="Select All (Ctrl+A)">
                        <div class="ribbon-tool-icon"><i class="fas fa-object-group"></i></div>
                        <div class="ribbon-tool-label">All</div>
                    </div>
                    <div class="ribbon-tool" onclick="deselectAll()" title="Deselect All">
                        <div class="ribbon-tool-icon"><i class="fas fa-ban"></i></div>
                        <div class="ribbon-tool-label">None</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Edit</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="undo()" title="Undo (Ctrl+Z)">
                        <div class="ribbon-tool-icon"><i class="fas fa-undo"></i></div>
                        <div class="ribbon-tool-label">Undo</div>
                    </div>
                    <div class="ribbon-tool" onclick="redo()" title="Redo (Ctrl+Y)">
                        <div class="ribbon-tool-icon"><i class="fas fa-redo"></i></div>
                        <div class="ribbon-tool-label">Redo</div>
                    </div>
                    <div class="ribbon-tool" onclick="deleteSelected()" title="Delete (Del)">
                        <div class="ribbon-tool-icon"><i class="fas fa-trash"></i></div>
                        <div class="ribbon-tool-label">Delete</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3D Ribbon -->
        <div class="ribbon-content" id="ribbon-3d">
            <div class="ribbon-group">
                <div class="ribbon-group-title">3D Objects</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('box')" title="Draw Box">
                        <div class="ribbon-tool-icon"><i class="fas fa-cube"></i></div>
                        <div class="ribbon-tool-label">Box</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('sphere')" title="Draw Sphere">
                        <div class="ribbon-tool-icon"><i class="fas fa-globe"></i></div>
                        <div class="ribbon-tool-label">Sphere</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('cylinder')" title="Draw Cylinder">
                        <div class="ribbon-tool-icon"><i class="fas fa-database"></i></div>
                        <div class="ribbon-tool-label">Cylinder</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">3D View</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="set3DView('top')" title="Top View">
                        <div class="ribbon-tool-icon"><i class="fas fa-chevron-up"></i></div>
                        <div class="ribbon-tool-label">Top</div>
                    </div>
                    <div class="ribbon-tool" onclick="set3DView('front')" title="Front View">
                        <div class="ribbon-tool-icon"><i class="fas fa-chevron-right"></i></div>
                        <div class="ribbon-tool-label">Front</div>
                    </div>
                    <div class="ribbon-tool" onclick="set3DView('iso')" title="Isometric View">
                        <div class="ribbon-tool-icon"><i class="fas fa-cubes"></i></div>
                        <div class="ribbon-tool-label">Iso</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Match Properties Tool -->
    <div id="matchPropertiesInfo" class="match-info" style="display: none;">
        Select source object for properties...
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Canvas Container -->
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <canvas id="canvas3D"></canvas>
            
            <!-- View Controls -->
            <div class="view-controls">
                <button class="view-btn active" onclick="setViewMode('2D')">2D</button>
                <button class="view-btn" onclick="setViewMode('3D')">3D</button>
            </div>
            
            <!-- 3D View Controls -->
            <div class="controls-3d" id="controls3D">
                <h4>3D View Controls</h4>
                <p>
                    • Left Mouse: Rotate<br>
                    • Middle Mouse: Pan<br>
                    • Scroll: Zoom<br>
                    • Right Mouse: Context Menu
                </p>
            </div>
            
            <!-- Professional Crosshair -->
            <div class="crosshair" id="crosshair">
                <div class="crosshair-line crosshair-h"></div>
                <div class="crosshair-line crosshair-v"></div>
                <div class="crosshair-center"></div>
            </div>
            
            <!-- Dynamic Input -->
            <div class="dynamic-input" id="dynamicInput">
                <span class="dynamic-input-label" id="dynamicLabel">Length:</span>
                <input type="text" class="dynamic-input-field" id="dynamicField" />
            </div>
            
            <!-- Input Dialog -->
            <div class="input-dialog" id="inputDialog">
                <div class="input-dialog-title" id="inputDialogTitle">Shape Properties</div>
                <div class="input-dialog-content" id="inputDialogContent">
                    <!-- Content will be added dynamically -->
                </div>
                <div class="input-dialog-buttons">
                    <button class="btn" onclick="cancelInputDialog()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmInputDialog()">OK</button>
                </div>
            </div>
            
            <!-- Command & Coordinates Bar -->
            <div class="input-bar">
                <div class="input-section" style="min-width: 200px;">
                    <span class="input-label">Command:</span>
                    <input type="text" class="command-input" id="commandInput" 
                           placeholder="Enter command or press F1 for help" 
                           autocomplete="off" />
                </div>
                <div class="input-section">
                    <span class="coord-display" id="coordinates">X: 0.00, Y: 0.00, Z: 0.00</span>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="toolbar">
                <!-- Snap Button with Menu -->
                <div class="toolbar-button" id="snapButton" onclick="toggleSnapMenu()" title="Object Snap">
                    <i class="fas fa-magnet"></i>
                    <div class="snap-menu" id="snapMenu">
                        <div class="snap-menu-title">Object Snap</div>
                        <div class="snap-option" id="snapEndpoint" onclick="toggleSnapSetting('endpoint')">
                            <span class="snap-option-icon"><i class="fas fa-dot-circle"></i></span>
                            <span>Endpoint</span>
                        </div>
                        <div class="snap-option" id="snapMidpoint" onclick="toggleSnapSetting('midpoint')">
                            <span class="snap-option-icon"><i class="fas fa-minus"></i></span>
                            <span>Midpoint</span>
                        </div>
                        <div class="snap-option" id="snapCenter" onclick="toggleSnapSetting('center')">
                            <span class="snap-option-icon"><i class="far fa-circle"></i></span>
                            <span>Center</span>
                        </div>
                        <div class="snap-option" id="snapIntersection" onclick="toggleSnapSetting('intersection')">
                            <span class="snap-option-icon"><i class="fas fa-times"></i></span>
                            <span>Intersection</span>
                        </div>
                        <div class="snap-option" id="snapPerpendicular" onclick="toggleSnapSetting('perpendicular')">
                            <span class="snap-option-icon"><i class="fas fa-ruler-vertical"></i></span>
                            <span>Perpendicular</span>
                        </div>
                        <div class="snap-option" id="snapTangent" onclick="toggleSnapSetting('tangent')">
                            <span class="snap-option-icon"><i class="fas fa-arrows-alt-v"></i></span>
                            <span>Tangent</span>
                        </div>
                        <div class="snap-option" id="snapNearest" onclick="toggleSnapSetting('nearest')">
                            <span class="snap-option-icon"><i class="fas fa-magnet"></i></span>
                            <span>Nearest</span>
                        </div>
                        <div class="snap-option" id="snapGrid" onclick="toggleSnapSetting('grid')">
                            <span class="snap-option-icon"><i class="fas fa-th"></i></span>
                            <span>Grid Snap</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ortho Button -->
                <div class="toolbar-button" id="orthoButton" onclick="toggleOrtho()" title="Orthogonal Mode">
                    <i class="fas fa-ruler-combined"></i>
                </div>
                
                <!-- Polar Button -->
                <div class="toolbar-button" id="polarButton" onclick="togglePolar()" title="Polar Tracking">
                    <i class="fas fa-compass"></i>
                </div>
                
                <!-- Grid Button -->
                <div class="toolbar-button" id="gridButton" onclick="toggleGrid()" title="Toggle Grid">
                    <i class="fas fa-th"></i>
                </div>
            </div>
            
            <!-- Snap Indicator -->
            <div class="snap-indicator" id="snapIndicator">
                <div class="snap-label" id="snapLabel">Grid</div>
            </div>
            
            <!-- Selection Box -->
            <div class="selection-box" id="selectionBox"></div>
            
            <!-- Zoom Window Overlay -->
            <div class="zoom-window-overlay" id="zoomWindowOverlay">
                <div class="zoom-window-box" id="zoomWindowBox"></div>
            </div>
            
            <!-- Context Menu -->
            <div class="context-menu" id="contextMenu">
                <div class="context-menu-item" onclick="repeatLastCommand()">
                    <i class="fas fa-redo"></i> Repeat Last
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="copySelected()">
                    <i class="fas fa-copy"></i> Copy
                </div>
                <div class="context-menu-item" onclick="pasteClipboard()">
                    <i class="fas fa-paste"></i> Paste
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="deleteSelected()">
                    <i class="fas fa-trash"></i> Delete
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="selectSimilar()">
                    <i class="fas fa-object-group"></i> Select Similar
                </div>
                <div class="context-menu-item" onclick="showProperties()">
                    <i class="fas fa-info-circle"></i> Properties
                </div>
            </div>
        </div>
        
        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="panel-header" onclick="togglePropertiesPanel()">
                <div class="panel-title">Properties</div>
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="panel-content">
                <!-- Object Properties -->
                <div class="panel-section">
                    <div class="section-title">Object Properties</div>
                    <div class="property-row">
                        <span class="property-label">Type:</span>
                        <span class="property-value" id="propType">None</span>
                    </div>
                    <div id="specificProperties"></div>
                </div>
                
                <!-- Layers Section -->
                <div class="panel-section">
                    <div class="section-title">
                        <span>Layers</span>
                        <div class="section-title-buttons">
                            <button class="btn btn-mini" onclick="window.cad && window.cad.ui && window.cad.ui.toggleAllLayers && window.cad.ui.toggleAllLayers(true)" title="Show All">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-mini" onclick="window.cad && window.cad.ui && window.cad.ui.toggleAllLayers && window.cad.ui.toggleAllLayers(false)" title="Hide All">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <button class="btn btn-mini" onclick="window.cad && window.cad.ui && window.cad.ui.showLayerManager && window.cad.ui.showLayerManager()" title="Layer Manager">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div id="layersList" class="layers-container"></div>
                </div>
                
                <!-- Drawing Settings -->
                <div class="panel-section">
                    <div class="section-title">Drawing Settings</div>
                    
                    <!-- Line Type -->
                    <div class="property-row">
                        <span class="property-label">Line Type:</span>
                        <button onclick="window.cad && window.cad.ui && window.cad.ui.showLinetypePanel && window.cad.ui.showLinetypePanel()" 
                                style="background: transparent; border: 1px solid var(--border-color); padding: 4px 8px; cursor: pointer; border-radius: 4px; color: var(--text-primary); width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span id="propLinetype">Continuous</span>
                            <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                        </button>
                    </div>
                    
                    <!-- Line Type Preview -->
                    <div id="linetypePreview" style="margin: 8px 0;"></div>
                    
                    <!-- Line Weight -->
                    <div class="property-row">
                        <span class="property-label">Line Weight:</span>
                        <button onclick="window.cad && window.cad.ui && window.cad.ui.showLineWeightPanel && window.cad.ui.showLineWeightPanel()"
                                style="background: transparent; border: 1px solid var(--border-color); padding: 4px 8px; cursor: pointer; border-radius: 4px; color: var(--text-primary); width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center;">
                            <span id="propLineweight">0.25 mm</span>
                            <i class="fas fa-chevron-down" style="font-size: 10px;"></i>
                        </button>
                    </div>
                    
                    <!-- Linetype Scale -->
                    <div class="property-row">
                        <span class="property-label">Linetype Scale:</span>
                        <div class="input-group">
                            <input type="number" id="linetypeScale" 
                                   value="1" min="0.1" max="10" step="0.1"
                                   onchange="window.cad && window.cad.linetypeManager && window.cad.linetypeManager.setGlobalLinetypeScale && window.cad.linetypeManager.setGlobalLinetypeScale(this.value)"
                                   style="width: 80px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px; border-radius: 4px;">
                            <button class="btn btn-mini" onclick="window.cad && window.cad.ui && window.cad.ui.showLinetypePanel && window.cad.ui.showLinetypePanel()">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Color -->
                    <div class="property-row">
                        <span class="property-label">Color:</span>
                        <div class="color-dropdown" id="colorDropdown">
                            <div class="color-dropdown-toggle" onclick="toggleColorDropdown()">
                                <div class="color-preview" id="currentColorPreview" style="background: #00d4aa;"></div>
                                <span id="currentColorText">#00d4aa</span>
                                <i class="fas fa-chevron-down" style="margin-left: auto;"></i>
                            </div>
                            <div class="color-dropdown-menu">
                                <div class="color-grid" id="colorGrid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Status Bar -->
    <footer class="bottom-bar">
        <div class="bottom-section">
            <div class="bottom-item">
                <span class="status-indicator" style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent-primary);"></span>
                <span id="statusMode">Phase 1 READY</span>
            </div>
        </div>
        
        <div class="bottom-section">
            <div class="bottom-item">
                <span class="bottom-label">LType:</span>
                <span class="bottom-value" id="statusLinetype">Continuous</span>
            </div>
            <div class="bottom-item">
                <span class="bottom-label">LWeight:</span>
                <span class="bottom-value" id="statusLineWeight">0.25 mm</span>
            </div>
        </div>
        
        <div class="bottom-section">
            <div class="bottom-item">
                Tool: <span class="bottom-value" id="statusTool">SELECT</span>
            </div>
            <div class="bottom-item">
                <span class="bottom-label">Layer:</span>
                <select id="currentLayerSelect" class="layer-select" onchange="window.cad && window.cad.setCurrentLayer && window.cad.setCurrentLayer(parseInt(this.value))">
                    <!-- سيتم ملؤها ديناميكياً -->
                </select>
            </div>
            <div class="bottom-item">
                Objects: <span class="bottom-value" id="statusObjects">0</span>
            </div>
        </div>
        
        <div class="bottom-section">
            <div class="bottom-item">
                SNAP: <span class="bottom-value" id="statusSnap">ON</span>
            </div>
            <div class="bottom-item">
                GRID: <span class="bottom-value" id="statusGrid">ON</span>
            </div>
            <div class="bottom-item">
                ORTHO: <span class="bottom-value" id="statusOrtho">OFF</span>
            </div>
            <div class="bottom-item">
                POLAR: <span class="bottom-value" id="statusPolar">OFF</span>
            </div>
            <div class="bottom-item">
                Units: 
                <select id="unitsSelect" onchange="changeUnits(this.value)" 
                        style="background: transparent; border: 1px solid var(--border-color); 
                               color: var(--text-primary); padding: 2px; font-size: 11px;">
                    <option value="mm">mm</option>
                    <option value="cm">cm</option>
                    <option value="m">m</option>
                    <option value="in">in</option>
                    <option value="ft">ft</option>
                </select>
            </div>
            <div class="bottom-item">
                <span class="bottom-value" id="fps">60 FPS</span>
            </div>
        </div>
    </footer>
    
    <!-- JavaScript Files -->
    <!-- Core Library (Clipper.js) only -->
    <script src="js/lib/clipper.js"></script>
    
    <!-- Main App Module (Vite) -->
    <script type="module" src="/js/main.js"></script>
    
    <!-- 🆕 Phase 1 Enhanced UI Helper Functions -->
    <script>
        // Ribbon tabs
        function showRibbon(tab) {
            document.querySelectorAll('.ribbon-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.ribbon-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`ribbon-${tab}`).classList.add('active');
        }
        
        // Array menu
        function toggleArrayMenu() {
            const menu = document.getElementById('arrayMenu');
            if (menu) {
                menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // 🆕 Enhanced Phase 1 keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // تأكد أن focus ليس على input field
            if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA') return;
            
            const key = e.key.toLowerCase();
            
            // 🆕 Phase 1 Tools Shortcuts
            switch(key) {
                case 's':
                    if (e.ctrlKey) return; // تجنب تداخل مع Ctrl+S (Save)
                    if (e.shiftKey) {
                        // Shift+S للStretch
                        setTool('stretch');
                        e.preventDefault();
                        console.log('🔧 Stretch tool activated via Shift+S');
                    }
                    break;
                    
                case 'b':
                    if (e.shiftKey) {
                        // Shift+B للBreak at Point
                        setTool('break-at-point');
                        console.log('📍 Break at Point tool activated via Shift+B');
                    } else {
                        // B للBreak
                        setTool('break');
                        console.log('✂️ Break tool activated via B');
                    }
                    e.preventDefault();
                    break;
                    
                // Enhanced existing shortcuts
                case 'm':
                    if (e.ctrlKey) return;
                    setTool('move');
                    e.preventDefault();
                    break;
                    
                case 'c':
                    if (e.ctrlKey) return; // تجنب تداخل مع Ctrl+C
                    setTool('copy');
                    e.preventDefault();
                    break;
                    
                case 'r':
                    if (e.ctrlKey) return;
                    setTool('rotate');
                    e.preventDefault();
                    break;
                    
                case 'l':
                    setTool('line');
                    e.preventDefault();
                    break;
                    
                case 'o':
                    if (e.ctrlKey) return; // تجنب تداخل مع Ctrl+O
                    setTool('offset');
                    e.preventDefault();
                    break;
                    
                case 't':
                    if (e.shiftKey) {
                        setTool('trim');
                    } else {
                        setTool('text');
                    }
                    e.preventDefault();
                    break;
                    
                case 'f':
                    setTool('fillet');
                    e.preventDefault();
                    break;
            }
        });
        
        // 🆕 Enhanced tool button state management
        function updateToolButtonState(activeTool) {
            // إزالة حالة active من جميع الأزرار
            document.querySelectorAll('.ribbon-tool').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // إضافة حالة active للأداة النشطة
            document.querySelectorAll('.ribbon-tool').forEach(btn => {
                const onclick = btn.getAttribute('onclick');
                if (onclick && onclick.includes(`'${activeTool}'`)) {
                    btn.classList.add('active');
                }
            });
            
            // 🆕 Update status for Phase 1 tools
            const phase1Tools = ['stretch', 'break', 'break-at-point'];
            if (phase1Tools.includes(activeTool)) {
                console.log(`🚀 Phase 1 tool activated: ${activeTool.toUpperCase()}`);
            }
        }
        
        // Layer dropdown update function
        function updateLayerDropdown() {
            const select = document.getElementById('currentLayerSelect');
            if (!select || !window.cad) return;
            
            // التحقق من وجود دالة getCurrentLayerId
            if (typeof window.cad.getCurrentLayerId !== 'function') {
                console.warn('getCurrentLayerId not available yet');
                return;
            }
            
            select.innerHTML = '';
            
            const layers = window.cad.layerManager ? 
                Array.from(window.cad.layerManager.layers.values()) : 
                Array.from(window.cad.layers.values());
            
            layers.forEach(layer => {
                const option = document.createElement('option');
                option.value = layer.id;
                option.textContent = layer.name;
                if (layer.id === window.cad.getCurrentLayerId()) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }

        // 🆕 Enhanced setTool function with Phase 1 support
        if (window.cad) {
            const originalSetTool = window.setTool;
            window.setTool = function(tool) {
                if (originalSetTool) {
                    originalSetTool(tool);
                }
                updateToolButtonState(tool);
                
                // 🆕 Phase 1 specific handling
                const phase1Tools = {
                    'stretch': '🔧 STRETCH - Select objects with crossing window',
                    'break': '✂️ BREAK - Select object to break between two points',
                    'break-at-point': '📍 BREAK AT POINT - Select object to break at single point'
                };
                
                if (phase1Tools[tool]) {
                    console.log(phase1Tools[tool]);
                }
            };
        }

        // Initialize layer dropdown when CAD is ready
        document.addEventListener('DOMContentLoaded', function() {
            let checkInterval;
            let attempts = 0;
            
            function checkCADReady() {
                attempts++;
                
                if (window.cad && typeof window.cad.getCurrentLayerId === 'function') {
                    clearInterval(checkInterval);
                    
                    // تحديث dropdown مرة واحدة عند البداية
                    updateLayerDropdown();
                    
                    // Hook into layer updates
                    if (window.cad.ui && window.cad.ui.updateLayersList) {
                        const originalUpdateLayersList = window.cad.ui.updateLayersList;
                        window.cad.ui.updateLayersList = function() {
                            originalUpdateLayersList.call(this);
                            updateLayerDropdown();
                        };
                    }
                    
                    console.log('✅ Layer dropdown initialized');
                    
                    // 🆕 Phase 1 Ready notification
                    console.log('🚀 TyrexCAD Phase 1 Tools Ready:');
                    console.log('  🔧 STRETCH (Shift+S) - Advanced stretching with crossing window');
                    console.log('  ✂️ BREAK (B) - Object breaking between two points');
                    console.log('  📍 BREAK AT POINT (Shift+B) - Object splitting at single point');
                    console.log('📊 Total modify tools: 11 (8 existing + 3 Phase 1)');
                    
                } else if (attempts > 50) {
                    clearInterval(checkInterval);
                    console.warn('CAD loading timeout - layer dropdown may not work properly');
                }
            }
            
            checkInterval = setInterval(checkCADReady, 100);
        });

        // 🆕 Phase 1 status check function
        window.getPhase1Status = function() {
            const phase1Tools = ['stretch', 'break', 'break-at-point'];
            return {
                phase: 1,
                completed: true,
                tools: phase1Tools.map(tool => ({
                    name: tool,
                    available: window.cad?.toolsManager?.tools?.has(tool) || false,
                    shortcut: tool === 'stretch' ? 'Shift+S' : 
                             tool === 'break' ? 'B' : 
                             'Shift+B'
                })),
                totalModifyTools: window.cad?.toolsManager?.tools ? 
                    Array.from(window.cad.toolsManager.tools.keys()).filter(name => 
                        ['move', 'copy', 'rotate', 'scale', 'mirror', 'trim', 'extend', 'offset', 'stretch', 'break', 'break-at-point'].includes(name)
                    ).length : 0,
                info: 'Phase 1 implementation complete with professional CAD behavior'
            };
        };

        // 🆕 Debug helper for Phase 1
        window.debugPhase1 = function() {
            console.log('🔍 Phase 1 Debug Info:');
            console.log('Tools available:', window.cad?.toolsManager?.getAvailableTools() || 'Not loaded');
            console.log('Active tool:', window.cad?.toolsManager?.activeTool?.name || 'None');
            console.log('Status:', window.getPhase1Status?.() || 'Phase 1 not ready');
        };
    </script>
    
</body>
</html>