<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TyrexCAD Professional v3.0 - Advanced CAD System</title>
    <!-- Font Awesome for Professional Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- أنماط CSS إضافية -->
    <style>
    /* أنماط الأزرار الصغيرة */
    .btn-mini {
        padding: 2px 6px;
        font-size: 10px;
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-mini:hover {
        background: var(--bg-hover);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
    }

    .section-title-buttons {
        display: flex;
        gap: 4px;
    }

    /* Layer Select في Bottom Bar */
    .layer-select {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        color: var(--text-primary);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        min-width: 120px;
    }

    /* Layer Manager Modal */
    .layer-manager {
        max-width: 800px;
        width: 90%;
    }

    .layer-manager-toolbar {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
    }

    .toolbar-separator {
        width: 1px;
        background: var(--border-color);
        margin: 0 8px;
    }

    .layer-manager-content {
        max-height: 400px;
        overflow-y: auto;
        background: var(--bg-tertiary);
        border-radius: 6px;
        padding: 8px;
    }

    .layer-table {
        width: 100%;
        border-collapse: collapse;
    }

    .layer-table th {
        background: var(--bg-secondary);
        padding: 8px;
        text-align: left;
        font-size: 12px;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--border-color);
    }

    .layer-table td {
        padding: 6px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .layer-table tr:hover {
        background: var(--bg-hover);
    }

    .layer-table input[type="checkbox"] {
        cursor: pointer;
    }

    .layer-table .color-swatch {
        width: 24px;
        height: 24px;
        border-radius: 3px;
        border: 1px solid var(--border-color);
        cursor: pointer;
        display: inline-block;
    }

    .layer-table input[type="text"] {
        background: transparent;
        border: 1px solid transparent;
        color: var(--text-primary);
        padding: 4px;
        width: 100%;
    }

    .layer-table input[type="text"]:focus {
        background: var(--bg-primary);
        border-color: var(--accent-primary);
        outline: none;
    }

    .layer-table .transparency-input {
        width: 60px;
        text-align: center;
    }

    /* إضافة أنماط CSS للـ current layer */
    .layer-table tr.current-layer {
        background: rgba(0, 212, 170, 0.1);
        border-left: 3px solid var(--accent-primary);
    }

    /* إصلاح أنماط القائمة السياقية */
    .grips-context-menu {
        position: fixed;
        background: var(--bg-panel);
        border: 1px solid var(--accent-primary);
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0, 212, 170, 0.15);
        min-width: 180px;
        padding: 4px 0;
        font-size: 14px;
        z-index: 1000;
    }

    .grips-context-menu .context-menu-item {
        padding: 8px 16px;
        cursor: pointer;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.2s ease;
    }

    .grips-context-menu .context-menu-item:hover {
        background: rgba(0, 212, 170, 0.1);
        color: var(--accent-primary);
    }

    .grips-context-menu .context-menu-item.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .grips-context-menu .context-menu-separator {
        height: 1px;
        background: rgba(255, 255, 255, 0.1);
        margin: 4px 0;
    }

    /* أنماط CSS إضافية للوحة الأوزان */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal-content {
        background: var(--bg-panel);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-width: 90%;
        max-height: 90%;
        overflow: hidden;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border-color);
    }

    .modal-header h2 {
        margin: 0;
        font-size: 18px;
        color: var(--text-primary);
    }

    .modal-close {
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 20px;
        cursor: pointer;
        padding: 4px 8px;
    }

    .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        padding: 16px 20px;
        border-top: 1px solid var(--border-color);
    }

    .weight-list {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 16px;
    }

    .weight-item {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 4px;
        transition: all 0.2s;
    }

    .weight-item:hover {
        background: var(--bg-hover);
    }

    .weight-item.active {
        background: var(--bg-hover);
        border: 1px solid var(--accent-primary);
    }

    .weight-preview {
        width: 100px;
        margin-right: 16px;
    }

    .weight-line {
        width: 100%;
        background: var(--text-primary);
        border-radius: 1px;
    }

    .weight-label {
        font-size: 13px;
        color: var(--text-primary);
    }

    .weight-display,
    .weight-scale {
        margin-top: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .weight-display label,
    .weight-scale label {
        font-size: 13px;
        color: var(--text-secondary);
    }

    .weight-scale input[type="range"] {
        width: 150px;
        margin: 0 12px;
    }

    .match-info {
        position: fixed;
        bottom: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-panel);
        border: 1px solid var(--accent-primary);
        border-radius: 4px;
        padding: 8px 16px;
        font-size: 12px;
        color: var(--text-primary);
        z-index: 100;
    }

    /* تكامل مع أدوات الرسم */
    .drawing-toolbar {
        display: flex;
        gap: 8px;
        padding: 8px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        margin-bottom: 8px;
    }

    .drawing-toolbar .tool-separator {
        width: 1px;
        background: var(--border-color);
        margin: 0 4px;
    }

    .quick-linetype {
        display: flex;
        gap: 4px;
    }

    .quick-linetype button {
        width: 32px;
        height: 32px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .quick-linetype button:hover {
        background: var(--bg-hover);
        border-color: var(--accent-primary);
    }

    .quick-linetype button.active {
        background: var(--accent-primary);
        border-color: var(--accent-primary);
    }

    /* Input group style */
    .input-group {
        display: flex;
        gap: 4px;
        align-items: center;
    }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">T</div>
    </div>
    
    <!-- Application Header -->
    <header class="app-header">
        <div class="app-branding">
            <div class="app-logo">T</div>
            <div>
                <div class="app-title">TyrexCAD Professional</div>
                <div class="app-version">Version 3.0</div>
            </div>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
            <button class="btn" onclick="newFile()"><i class="fas fa-file"></i> New</button>
            <button class="btn" onclick="openFile()"><i class="fas fa-folder-open"></i> Open</button>
            <button class="btn" onclick="saveFile()"><i class="fas fa-save"></i> Save</button>
            <button class="btn" onclick="exportFile()"><i class="fas fa-file-export"></i> Export</button>
        </div>
    </header>
    
    <!-- Ribbon Interface -->
    <div class="ribbon-container">
        <div class="ribbon-tabs">
            <div class="ribbon-tab active" onclick="showRibbon('draw')">Draw</div>
            <div class="ribbon-tab" onclick="showRibbon('modify')">Modify</div>
            <div class="ribbon-tab" onclick="showRibbon('annotate')">Annotate</div>
            <div class="ribbon-tab" onclick="showRibbon('view')">View</div>
            <div class="ribbon-tab" onclick="showRibbon('tools')">Tools</div>
            <div class="ribbon-tab" onclick="showRibbon('3d')">3D</div>
        </div>
        
        <!-- Draw Ribbon -->
        <div class="ribbon-content active" id="ribbon-draw">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Lines</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('line')" title="Draw Line">
                        <div class="ribbon-tool-icon"><i class="fas fa-slash"></i></div>
                        <div class="ribbon-tool-label">Line</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('polyline')" title="Draw Polyline">
                        <div class="ribbon-tool-icon"><i class="fas fa-route"></i></div>
                        <div class="ribbon-tool-label">Polyline</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Shapes</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('rectangle')" title="Draw Rectangle">
                        <div class="ribbon-tool-icon"><i class="far fa-square"></i></div>
                        <div class="ribbon-tool-label">Rectangle</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('circle')" title="Draw Circle">
                        <div class="ribbon-tool-icon"><i class="far fa-circle"></i></div>
                        <div class="ribbon-tool-label">Circle</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('arc')" title="Draw Arc">
                        <div class="ribbon-tool-icon"><i class="fas fa-bezier-curve"></i></div>
                        <div class="ribbon-tool-label">Arc</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('ellipse')" title="Draw Ellipse">
                        <div class="ribbon-tool-icon"><i class="fas fa-egg"></i></div>
                        <div class="ribbon-tool-label">Ellipse</div>
                    </div>
                    
                    <!-- Advanced Drawing Tools -->
                    <button id="polygon" class="tool-btn" onclick="setTool('polygon')" title="Polygon (POL)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L3 7V17L12 22L21 17V7L12 2Z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- إضافة في قسم الـ Ribbon - Draw -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Layers</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="showLayerManager()" title="Layer Manager">
                        <div class="ribbon-tool-icon"><i class="fas fa-layer-group"></i></div>
                        <div class="ribbon-tool-label">Manager</div>
                    </div>
                    <div class="ribbon-tool" onclick="window.cad && cad.matchLayer()" title="Match Layer">
                        <div class="ribbon-tool-icon"><i class="fas fa-eyedropper"></i></div>
                        <div class="ribbon-tool-label">Match</div>
                    </div>
                    <div class="ribbon-tool" onclick="window.cad && cad.ui.showLayerStatesDialog()" title="Layer States">
                        <div class="ribbon-tool-icon"><i class="fas fa-save"></i></div>
                        <div class="ribbon-tool-label">States</div>
                    </div>
                </div>
            </div>
            
            <!-- إضافة في الـ Ribbon - Draw -->
            <div class="ribbon-group">
                <div class="ribbon-group-title">Line Properties</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="window.cad && cad.ui.showLinetypePanel()" title="Linetype Manager">
                        <div class="ribbon-tool-icon"><i class="fas fa-grip-lines"></i></div>
                        <div class="ribbon-tool-label">Linetypes</div>
                    </div>
                    <div class="ribbon-tool" onclick="showLineWeightPanel()" title="Line Weight">
                        <div class="ribbon-tool-icon"><i class="fas fa-weight"></i></div>
                        <div class="ribbon-tool-label">Weights</div>
                    </div>
                    <div class="ribbon-tool" onclick="matchProperties()" title="Match Properties">
                        <div class="ribbon-tool-icon"><i class="fas fa-paint-brush"></i></div>
                        <div class="ribbon-tool-label">Match</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modify Ribbon -->
        <div class="ribbon-content" id="ribbon-modify">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Transform</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('move')" title="Move Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-arrows-alt"></i></div>
                        <div class="ribbon-tool-label">Move</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('copy')" title="Copy Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-copy"></i></div>
                        <div class="ribbon-tool-label">Copy</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('rotate')" title="Rotate Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-sync-alt"></i></div>
                        <div class="ribbon-tool-label">Rotate</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('scale')" title="Scale Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-expand-arrows-alt"></i></div>
                        <div class="ribbon-tool-label">Scale</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('mirror')" title="Mirror Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-object-ungroup"></i></div>
                        <div class="ribbon-tool-label">Mirror</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Edit</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('trim')" title="Trim Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-cut"></i></div>
                        <div class="ribbon-tool-label">Trim</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('extend')" title="Extend Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-expand"></i></div>
                        <div class="ribbon-tool-label">Extend</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('offset')" title="Offset Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-clone"></i></div>
                        <div class="ribbon-tool-label">Offset</div>
                    </div>
                    
                    <div class="tool-separator"></div>
                    
                    <!-- Advanced Modify Tools -->
                    <button id="fillet" class="tool-btn" onclick="setTool('fillet')" title="Fillet (F)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4V16C4 18 6 20 8 20H20" stroke="currentColor" stroke-width="2"/>
                            <path d="M4 16Q4 20 8 20" stroke="currentColor" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                    
                    <button id="chamfer" class="tool-btn" onclick="setTool('chamfer')" title="Chamfer (CHA)">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4 4V16L8 20H20" stroke="currentColor" stroke-width="2"/>
                            <path d="M4 16L8 20" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </button>
                    
                    <div class="tool-separator"></div>
                    
                    <!-- Array Tools Dropdown -->
                    <div class="dropdown">
                        <button class="tool-btn" onclick="toggleArrayMenu()" title="Array (AR)">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="3" width="6" height="6" stroke="currentColor" stroke-width="2"/>
                                <rect x="9" y="3" width="6" height="6" stroke="currentColor" stroke-width="2"/>
                                <rect x="15" y="3" width="6" height="6" stroke="currentColor" stroke-width="2"/>
                                <rect x="3" y="9" width="6" height="6" stroke="currentColor" stroke-width="2"/>
                                <rect x="9" y="9" width="6" height="6" stroke="currentColor" stroke-width="2"/>
                                <rect x="15" y="9" width="6" height="6" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </button>
                        <div id="arrayMenu" class="dropdown-content">
                            <button onclick="setTool('rectangular-array')">Rectangular Array</button>
                            <button onclick="setTool('polar-array')">Polar Array</button>
                            <button onclick="setTool('path-array')">Path Array</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Boolean Operations Section -->
            <div class="tool-section">
                <div class="section-label">BOOLEAN</div>
                
                <button class="tool-btn" onclick="activateTool('union')" title="Union (UNI)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="14" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M10 6.5C11.5 8 12.5 10 12.5 12C12.5 14 11.5 16 10 17.5C8.5 16 7.5 14 7.5 12C7.5 10 8.5 8 10 6.5Z" fill="currentColor" opacity="0.3"/>
                    </svg>
                </button>
                
                <button class="tool-btn" onclick="activateTool('difference')" title="Difference (DIF)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none"/>
                        <circle cx="14" cy="12" r="6" stroke="currentColor" stroke-width="2" stroke-dasharray="3 3"/>
                        <path d="M10 6.5C8.5 8 7.5 10 7.5 12C7.5 14 8.5 16 10 17.5" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                
                <button class="tool-btn" onclick="activateTool('intersection')" title="Intersection (INT)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="10" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none" opacity="0.5"/>
                        <circle cx="14" cy="12" r="6" stroke="currentColor" stroke-width="2" fill="none" opacity="0.5"/>
                        <path d="M10 6.5C11.5 8 12.5 10 12.5 12C12.5 14 11.5 16 10 17.5C11.5 16 12.5 14 12.5 12C12.5 10 11.5 8 10 6.5Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            
            <!-- Analysis Tools Section -->
            <div class="tool-section">
                <div class="section-label">ANALYSIS</div>
                
                <button class="tool-btn" onclick="activateTool('distance-analysis')" title="Distance (DIST)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4 12H20M4 12L7 9M4 12L7 15M20 12L17 9M20 12L17 15" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                
                <button class="tool-btn" onclick="activateTool('area-analysis')" title="Area">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="4" y="4" width="16" height="16" stroke="currentColor" stroke-width="2" fill="currentColor" opacity="0.2"/>
                        <text x="12" y="12" text-anchor="middle" dominant-baseline="middle" fill="currentColor" font-size="10">A</text>
                    </svg>
                </button>
                
                <button class="tool-btn" onclick="activateTool('properties-analysis')" title="Properties (PROP)">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="3" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            
            <!-- Curve Operations Section -->
            <div class="tool-section">
                <div class="section-label">CURVES</div>
                
                <button class="tool-btn" onclick="activateTool('convert-to-polyline')" title="Convert to Polyline">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="8" stroke="currentColor" stroke-width="1" stroke-dasharray="2 2" opacity="0.5"/>
                        <polyline points="12,4 18,8 20,12 18,16 12,20 6,16 4,12 6,8 12,4" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </button>
                
                <button class="tool-btn" onclick="activateTool('simplify-polyline')" title="Simplify">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="4,4 8,12 16,8 20,20" stroke="currentColor" stroke-width="1" stroke-dasharray="2 2"/>
                        <polyline points="4,4 20,20" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </button>
                
                <button class="tool-btn" onclick="activateTool('smooth-polyline')" title="Smooth">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M4,12 Q8,4 12,12 T20,12" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Annotate Ribbon -->
        <div class="ribbon-content" id="ribbon-annotate">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Text & Dimensions</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('text')" title="Add Text">
                        <div class="ribbon-tool-icon"><i class="fas fa-text-height"></i></div>
                        <div class="ribbon-tool-label">Text</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension')" title="Linear Dimension">
                        <div class="ribbon-tool-icon"><i class="fas fa-ruler-horizontal"></i></div>
                        <div class="ribbon-tool-label">Linear</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension-angular')" title="Angular Dimension">
                        <div class="ribbon-tool-icon"><i class="fas fa-drafting-compass"></i></div>
                        <div class="ribbon-tool-label">Angular</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension-radius')" title="Radius Dimension">
                        <div class="ribbon-tool-icon"><i class="fas fa-circle-notch"></i></div>
                        <div class="ribbon-tool-label">Radius</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('dimension-diameter')" title="Diameter Dimension">
                        <div class="ribbon-tool-icon"><i class="fas fa-circle"></i></div>
                        <div class="ribbon-tool-label">Diameter</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- View Ribbon -->
        <div class="ribbon-content" id="ribbon-view">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Navigation</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('pan')" title="Pan View">
                        <div class="ribbon-tool-icon"><i class="fas fa-hand-paper"></i></div>
                        <div class="ribbon-tool-label">Pan</div>
                    </div>
                    <div class="ribbon-tool" onclick="zoomExtents()" title="Zoom Extents">
                        <div class="ribbon-tool-icon"><i class="fas fa-compress-arrows-alt"></i></div>
                        <div class="ribbon-tool-label">Zoom All</div>
                    </div>
                    <div class="ribbon-tool" onclick="zoomWindow()" title="Zoom Window">
                        <div class="ribbon-tool-icon"><i class="fas fa-search-plus"></i></div>
                        <div class="ribbon-tool-label">Zoom Window</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tools Ribbon -->
        <div class="ribbon-content" id="ribbon-tools">
            <div class="ribbon-group">
                <div class="ribbon-group-title">Selection</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool active" onclick="setTool('select')" title="Select Objects">
                        <div class="ribbon-tool-icon"><i class="fas fa-mouse-pointer"></i></div>
                        <div class="ribbon-tool-label">Select</div>
                    </div>
                    <div class="ribbon-tool" onclick="selectAll()" title="Select All">
                        <div class="ribbon-tool-icon"><i class="fas fa-object-group"></i></div>
                        <div class="ribbon-tool-label">All</div>
                    </div>
                    <div class="ribbon-tool" onclick="deselectAll()" title="Deselect All">
                        <div class="ribbon-tool-icon"><i class="fas fa-ban"></i></div>
                        <div class="ribbon-tool-label">None</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">Edit</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="undo()" title="Undo">
                        <div class="ribbon-tool-icon"><i class="fas fa-undo"></i></div>
                        <div class="ribbon-tool-label">Undo</div>
                    </div>
                    <div class="ribbon-tool" onclick="redo()" title="Redo">
                        <div class="ribbon-tool-icon"><i class="fas fa-redo"></i></div>
                        <div class="ribbon-tool-label">Redo</div>
                    </div>
                    <div class="ribbon-tool" onclick="deleteSelected()" title="Delete">
                        <div class="ribbon-tool-icon"><i class="fas fa-trash"></i></div>
                        <div class="ribbon-tool-label">Delete</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 3D Ribbon -->
        <div class="ribbon-content" id="ribbon-3d">
            <div class="ribbon-group">
                <div class="ribbon-group-title">3D Objects</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="setTool('box')" title="Draw Box">
                        <div class="ribbon-tool-icon"><i class="fas fa-cube"></i></div>
                        <div class="ribbon-tool-label">Box</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('sphere')" title="Draw Sphere">
                        <div class="ribbon-tool-icon"><i class="fas fa-globe"></i></div>
                        <div class="ribbon-tool-label">Sphere</div>
                    </div>
                    <div class="ribbon-tool" onclick="setTool('cylinder')" title="Draw Cylinder">
                        <div class="ribbon-tool-icon"><i class="fas fa-database"></i></div>
                        <div class="ribbon-tool-label">Cylinder</div>
                    </div>
                </div>
            </div>
            
            <div class="ribbon-group">
                <div class="ribbon-group-title">3D View</div>
                <div class="ribbon-group-content">
                    <div class="ribbon-tool" onclick="set3DView('top')" title="Top View">
                        <div class="ribbon-tool-icon"><i class="fas fa-chevron-up"></i></div>
                        <div class="ribbon-tool-label">Top</div>
                    </div>
                    <div class="ribbon-tool" onclick="set3DView('front')" title="Front View">
                        <div class="ribbon-tool-icon"><i class="fas fa-chevron-right"></i></div>
                        <div class="ribbon-tool-label">Front</div>
                    </div>
                    <div class="ribbon-tool" onclick="set3DView('iso')" title="Isometric View">
                        <div class="ribbon-tool-icon"><i class="fas fa-cubes"></i></div>
                        <div class="ribbon-tool-label">Iso</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Line Weight Panel Modal -->
    <div id="lineWeightPanel" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Line Weight Settings</h2>
                <button class="modal-close" onclick="closeLineWeightPanel()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="weight-list">
                    <!-- سيتم ملؤها ديناميكياً -->
                </div>
                <div class="weight-display">
                    <label>Display line weights</label>
                    <input type="checkbox" id="displayLineWeights" checked>
                </div>
                <div class="weight-scale">
                    <label>Adjust display scale:</label>
                    <input type="range" id="weightDisplayScale" 
                           min="0.5" max="2" step="0.1" value="1">
                    <span id="weightScaleValue">1.0</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="applyLineWeightSettings()">OK</button>
                <button class="btn" onclick="closeLineWeightPanel()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Match Properties Tool -->
    <div id="matchPropertiesInfo" class="match-info" style="display: none;">
        Select source object for properties...
    </div>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Canvas Container -->
        <div class="canvas-container" id="canvasContainer">
            <canvas id="mainCanvas"></canvas>
            <canvas id="canvas3D"></canvas>
            
            <!-- View Controls -->
            <div class="view-controls">
                <button class="view-btn active" onclick="setViewMode('2D')">2D</button>
                <button class="view-btn" onclick="setViewMode('3D')">3D</button>
            </div>
            
            <!-- 3D View Controls -->
            <div class="controls-3d" id="controls3D">
                <h4>3D View Controls</h4>
                <p>
                    • Left Mouse: Rotate<br>
                    • Middle Mouse: Pan<br>
                    • Scroll: Zoom<br>
                    • Right Mouse: Context Menu
                </p>
            </div>
            
            <!-- Professional Crosshair -->
            <div class="crosshair" id="crosshair">
                <div class="crosshair-line crosshair-h"></div>
                <div class="crosshair-line crosshair-v"></div>
                <div class="crosshair-center"></div>
            </div>
            
            <!-- Dynamic Input -->
            <div class="dynamic-input" id="dynamicInput">
                <span class="dynamic-input-label" id="dynamicLabel">Length:</span>
                <input type="text" class="dynamic-input-field" id="dynamicField" />
            </div>
            
            <!-- Input Dialog -->
            <div class="input-dialog" id="inputDialog">
                <div class="input-dialog-title" id="inputDialogTitle">Shape Properties</div>
                <div class="input-dialog-content" id="inputDialogContent">
                    <!-- Content will be added dynamically -->
                </div>
                <div class="input-dialog-buttons">
                    <button class="btn" onclick="cancelInputDialog()">Cancel</button>
                    <button class="btn btn-primary" onclick="confirmInputDialog()">OK</button>
                </div>
            </div>
            
            <!-- Command & Coordinates Bar -->
            <div class="input-bar">
                <div class="input-section" style="min-width: 200px;">
                    <span class="input-label">Command:</span>
                    <input type="text" class="command-input" id="commandInput" 
                           placeholder="Enter command or press F1 for help" 
                           autocomplete="off" />
                </div>
                <div class="input-section">
                    <span class="coord-display" id="coordinates">X: 0.00, Y: 0.00, Z: 0.00</span>
                </div>
            </div>
            
            <!-- Toolbar -->
            <div class="toolbar">
                <!-- Snap Button with Menu -->
                <div class="toolbar-button" id="snapButton" onclick="toggleSnapMenu()" title="Object Snap">
                    <i class="fas fa-magnet"></i>
                    <div class="snap-menu" id="snapMenu">
                        <div class="snap-menu-title">Object Snap</div>
                        <div class="snap-option" id="snapEndpoint" onclick="toggleSnapSetting('endpoint')">
                            <span class="snap-option-icon"><i class="fas fa-dot-circle"></i></span>
                            <span>Endpoint</span>
                        </div>
                        <div class="snap-option" id="snapMidpoint" onclick="toggleSnapSetting('midpoint')">
                            <span class="snap-option-icon"><i class="fas fa-minus"></i></span>
                            <span>Midpoint</span>
                        </div>
                        <div class="snap-option" id="snapCenter" onclick="toggleSnapSetting('center')">
                            <span class="snap-option-icon"><i class="far fa-circle"></i></span>
                            <span>Center</span>
                        </div>
                        <div class="snap-option" id="snapIntersection" onclick="toggleSnapSetting('intersection')">
                            <span class="snap-option-icon"><i class="fas fa-times"></i></span>
                            <span>Intersection</span>
                        </div>
                        <div class="snap-option" id="snapPerpendicular" onclick="toggleSnapSetting('perpendicular')">
                            <span class="snap-option-icon"><i class="fas fa-ruler-vertical"></i></span>
                            <span>Perpendicular</span>
                        </div>
                        <div class="snap-option" id="snapTangent" onclick="toggleSnapSetting('tangent')">
                            <span class="snap-option-icon"><i class="fas fa-arrows-alt-v"></i></span>
                            <span>Tangent</span>
                        </div>
                        <div class="snap-option" id="snapNearest" onclick="toggleSnapSetting('nearest')">
                            <span class="snap-option-icon"><i class="fas fa-magnet"></i></span>
                            <span>Nearest</span>
                        </div>
                        <div class="snap-option" id="snapGrid" onclick="toggleSnapSetting('grid')">
                            <span class="snap-option-icon"><i class="fas fa-th"></i></span>
                            <span>Grid Snap</span>
                        </div>
                    </div>
                </div>
                
                <!-- Ortho Button -->
                <div class="toolbar-button" id="orthoButton" onclick="toggleOrtho()" title="Orthogonal Mode">
                    <i class="fas fa-ruler-combined"></i>
                </div>
                
                <!-- Polar Button -->
                <div class="toolbar-button" id="polarButton" onclick="togglePolar()" title="Polar Tracking">
                    <i class="fas fa-compass"></i>
                </div>
                
                <!-- Grid Button -->
                <div class="toolbar-button" id="gridButton" onclick="toggleGrid()" title="Toggle Grid">
                    <i class="fas fa-th"></i>
                </div>
            </div>
            
            <!-- Snap Indicator -->
            <div class="snap-indicator" id="snapIndicator">
                <div class="snap-label" id="snapLabel">Grid</div>
            </div>
            
            <!-- Selection Box -->
            <div class="selection-box" id="selectionBox"></div>
            
            <!-- Zoom Window Overlay -->
            <div class="zoom-window-overlay" id="zoomWindowOverlay">
                <div class="zoom-window-box" id="zoomWindowBox"></div>
            </div>
            
            <!-- Context Menu -->
            <div class="context-menu" id="contextMenu">
                <div class="context-menu-item" onclick="repeatLastCommand()">
                    <i class="fas fa-redo"></i> Repeat Last
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="copySelected()">
                    <i class="fas fa-copy"></i> Copy
                </div>
                <div class="context-menu-item" onclick="pasteClipboard()">
                    <i class="fas fa-paste"></i> Paste
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="deleteSelected()">
                    <i class="fas fa-trash"></i> Delete
                </div>
                <div class="context-menu-separator"></div>
                <div class="context-menu-item" onclick="selectSimilar()">
                    <i class="fas fa-object-group"></i> Select Similar
                </div>
                <div class="context-menu-item" onclick="showProperties()">
                    <i class="fas fa-info-circle"></i> Properties
                </div>
            </div>
        </div>
        
        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="panel-header" onclick="togglePropertiesPanel()">
                <div class="panel-title">Properties</div>
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="panel-content">
                <!-- Object Properties -->
                <div class="panel-section">
                    <div class="section-title">Object Properties</div>
                    <div class="property-row">
                        <span class="property-label">Type:</span>
                        <span class="property-value" id="propType">None</span>
                    </div>
                    <div id="specificProperties"></div>
                </div>
                
                <!-- تحديث قسم الطبقات في Properties Panel -->
                <div class="panel-section">
                    <div class="section-title">
                        <span>Layers</span>
                        <div class="section-title-buttons">
                            <button class="btn btn-mini" onclick="window.cad && cad.ui.toggleAllLayers(true)" title="Show All">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-mini" onclick="window.cad && cad.ui.toggleAllLayers(false)" title="Hide All">
                                <i class="fas fa-eye-slash"></i>
                            </button>
                            <button class="btn btn-mini" onclick="showLayerManager()" title="Layer Manager">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    <div id="layersList" class="layers-container"></div>
                </div>
                
                <!-- Drawing Settings -->
                <div class="panel-section">
                    <div class="section-title">Drawing Settings</div>
                    
                    <!-- Line Type -->
                    <div class="property-row">
                        <span class="property-label">Line Type:</span>
                        <select id="linetypeSelect" onchange="window.cad && cad.setLinetype(this.value)"
                                style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px; border-radius: 4px;">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </select>
                    </div>
                    
                    <!-- Line Type Preview -->
                    <div id="linetypePreview"></div>
                    
                    <!-- Line Weight -->
                    <div class="property-row">
                        <span class="property-label">Line Weight:</span>
                        <select id="lineWeightSelect" onchange="window.cad && cad.setLineWeight(this.value)"
                                style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px; border-radius: 4px;">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </select>
                    </div>
                    
                    <!-- Linetype Scale -->
                    <div class="property-row">
                        <span class="property-label">Linetype Scale:</span>
                        <div class="input-group">
                            <input type="number" id="linetypeScale" 
                                   value="1" min="0.1" max="10" step="0.1"
                                   onchange="window.cad && cad.linetypeManager && cad.linetypeManager.setGlobalLinetypeScale(this.value)"
                                   style="width: 80px; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px; border-radius: 4px;">
                            <button class="btn btn-mini" onclick="window.cad && cad.ui.showLinetypePanel()">
                                <i class="fas fa-cog"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Color -->
                    <div class="property-row">
                        <span class="property-label">Color:</span>
                        <div class="color-dropdown" id="colorDropdown">
                            <div class="color-dropdown-toggle" onclick="toggleColorDropdown()">
                                <div class="color-preview" id="currentColorPreview" style="background: #00d4aa;"></div>
                                <span id="currentColorText">#00d4aa</span>
                                <i class="fas fa-chevron-down" style="margin-left: auto;"></i>
                            </div>
                            <div class="color-dropdown-menu">
                                <div class="color-grid" id="colorGrid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bottom Status Bar -->
    <footer class="bottom-bar">
        <div class="bottom-section">
            <div class="bottom-item">
                <span class="status-indicator" style="width: 6px; height: 6px; border-radius: 50%; background: var(--accent-primary);"></span>
                <span id="statusMode">READY</span>
            </div>
        </div>
        
        <!-- إضافة في Bottom Bar -->
        <div class="bottom-section">
            <div class="bottom-item">
                <span class="bottom-label">LType:</span>
                <span class="bottom-value" id="statusLinetype">Continuous</span>
            </div>
            <div class="bottom-item">
                <span class="bottom-label">LWeight:</span>
                <span class="bottom-value" id="statusLineWeight">0.25 mm</span>
            </div>
        </div>
        
        <div class="bottom-section">
            <div class="bottom-item">
                Tool: <span class="bottom-value" id="statusTool">SELECT</span>
            </div>
            <!-- إضافة Layer Dropdown في الـ Bottom Bar -->
            <div class="bottom-item">
                <span class="bottom-label">Layer:</span>
                <select id="currentLayerSelect" class="layer-select" onchange="window.cad && cad.setCurrentLayer(parseInt(this.value))">
                    <!-- سيتم ملؤها ديناميكياً -->
                </select>
            </div>
            <div class="bottom-item">
                Objects: <span class="bottom-value" id="statusObjects">0</span>
            </div>
        </div>
        
        <div class="bottom-section">
            <div class="bottom-item">
                SNAP: <span class="bottom-value" id="statusSnap">ON</span>
            </div>
            <div class="bottom-item">
                GRID: <span class="bottom-value" id="statusGrid">ON</span>
            </div>
            <div class="bottom-item">
                ORTHO: <span class="bottom-value" id="statusOrtho">OFF</span>
            </div>
            <div class="bottom-item">
                POLAR: <span class="bottom-value" id="statusPolar">OFF</span>
            </div>
            <div class="bottom-item">
                Units: 
                <select id="unitsSelect" onchange="changeUnits(this.value)" 
                        style="background: transparent; border: 1px solid var(--border-color); 
                               color: var(--text-primary); padding: 2px; font-size: 11px;">
                    <option value="mm">mm</option>
                    <option value="cm">cm</option>
                    <option value="m">m</option>
                    <option value="in">in</option>
                    <option value="ft">ft</option>
                </select>
            </div>
            <div class="bottom-item">
                <span class="bottom-value" id="fps">60 FPS</span>
            </div>
        </div>
    </footer>
    
    <!-- Layer Manager Modal -->
    <div id="layerManagerModal" class="modal" style="display: none;">
        <div class="modal-content layer-manager">
            <div class="modal-header">
                <h2>Layer Manager</h2>
                <button class="modal-close" onclick="closeLayerManager()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="layer-manager-toolbar">
                    <button class="btn" onclick="window.cad && cad.addLayer()">
                        <i class="fas fa-plus"></i> New Layer
                    </button>
                    <button class="btn" onclick="deleteSelectedLayers()">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                    <button class="btn" onclick="window.cad && cad.ui.showLayerStatesDialog()">
                        <i class="fas fa-save"></i> States
                    </button>
                    <div class="toolbar-separator"></div>
                    <button class="btn" onclick="window.cad && cad.ui.toggleAllLayers(true)">
                        <i class="fas fa-eye"></i> Show All
                    </button>
                    <button class="btn" onclick="window.cad && cad.ui.toggleAllLayers(false)">
                        <i class="fas fa-eye-slash"></i> Hide All
                    </button>
                </div>
                <div class="layer-manager-content">
                    <table class="layer-table">
                        <thead>
                            <tr>
                                <th width="30"><input type="checkbox" id="selectAllLayers"></th>
                                <th width="30"><i class="fas fa-eye" title="Visibility"></i></th>
                                <th width="30"><i class="fas fa-snowflake" title="Freeze/Thaw"></i></th>
                                <th width="30"><i class="fas fa-lock" title="Lock/Unlock"></i></th>
                                <th width="30"><i class="fas fa-print" title="Plot"></i></th>
                                <th width="40">Color</th>
                                <th>Name</th>
                                <th width="60">Objects</th>
                                <th width="80">Transparency</th>
                                <th width="30"></th>
                            </tr>
                        </thead>
                        <tbody id="layerTableBody">
                            <!-- سيتم ملؤها ديناميكياً -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="applyLayerChanges()">Apply</button>
                <button class="btn" onclick="closeLayerManager()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Main Module Entry Point -->
    <script type="module" src="/js/main.js"></script>
    
    <!-- Simple UI Helper -->
    <script>
        // Ribbon tabs
        function showRibbon(tab) {
            document.querySelectorAll('.ribbon-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.ribbon-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`ribbon-${tab}`).classList.add('active');
        }
        
        // Array menu
        function toggleArrayMenu() {
            const menu = document.getElementById('arrayMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
    </script>
    
    <!-- JavaScript للـ Layer Manager -->
    <script>
    function showLayerManager() {
        if (!window.cad) {
            console.error('CAD not loaded yet');
            return;
        }
        const modal = document.getElementById('layerManagerModal');
        modal.style.display = 'flex';
        updateLayerTable();
    }

    function closeLayerManager() {
        document.getElementById('layerManagerModal').style.display = 'none';
    }

    // إصلاح دالة updateLayerTable
    function updateLayerTable() {
        const tbody = document.getElementById('layerTableBody');
        if (!tbody || !window.cad) return;
        
        // التحقق من وجود الدوال المطلوبة
        if (typeof window.cad.getCurrentLayerId !== 'function') {
            console.warn('CAD not fully initialized');
            return;
        }
        
        tbody.innerHTML = '';
        
        const layers = window.cad.layerManager ? 
            Array.from(window.cad.layerManager.layers.values()) : 
            Array.from(window.cad.layers.values());
        
        layers.sort((a, b) => b.id - a.id);
        
        const currentLayerId = window.cad.getCurrentLayerId();
        
        layers.forEach(layer => {
            const shapeCount = window.cad.shapes.filter(s => s.layerId === layer.id).length;
            const row = document.createElement('tr');
            
            if (layer.id === currentLayerId) {
                row.classList.add('current-layer');
            }
            
            row.innerHTML = `
                <td><input type="checkbox" class="layer-checkbox" data-layer-id="${layer.id}"></td>
                <td>
                    <input type="checkbox" ${layer.visible ? 'checked' : ''} 
                           onchange="window.cad.toggleLayerVisibility(${layer.id})">
                </td>
                <td>
                    <input type="checkbox" ${layer.frozen ? 'checked' : ''} 
                           onchange="window.cad.toggleLayerFreeze(${layer.id})"
                           ${layer.id === currentLayerId ? 'disabled' : ''}>
                </td>
                <td>
                    <input type="checkbox" ${layer.locked ? 'checked' : ''} 
                           onchange="window.cad.toggleLayerLock(${layer.id})">
                </td>
                <td>
                    <input type="checkbox" ${layer.plot !== false ? 'checked' : ''} 
                           onchange="window.cad.layerManager && window.cad.layerManager.togglePlot(${layer.id})">
                </td>
                <td>
                    <div class="color-swatch" style="background: ${layer.color}"
                         onclick="window.cad.changeLayerColor(${layer.id})"></div>
                </td>
                <td>
                    <input type="text" value="${layer.name}" 
                           onchange="window.cad.renameLayer(${layer.id}, this.value)"
                           ${layer.id === 0 ? 'readonly' : ''}>
                </td>
                <td style="text-align: center;">${shapeCount}</td>
                <td>
                    <input type="number" class="transparency-input" 
                           value="${layer.transparency || 0}" min="0" max="100"
                           onchange="window.cad.layerManager && window.cad.layerManager.setLayerTransparency(${layer.id}, this.value)">%
                </td>
                <td>
                    ${layer.id !== 0 ? `<button class="btn btn-mini" onclick="window.cad.deleteLayer(${layer.id})">
                        <i class="fas fa-trash"></i>
                    </button>` : ''}
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function deleteSelectedLayers() {
        if (!window.cad) {
            console.error('CAD not loaded yet');
            return;
        }
        
        const checkboxes = document.querySelectorAll('.layer-checkbox:checked');
        const layerIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.layerId));
        
        if (layerIds.length === 0) {
            window.cad.updateStatus('No layers selected');
            return;
        }
        
        if (confirm(`Delete ${layerIds.length} layer(s)?`)) {
            layerIds.forEach(id => window.cad.deleteLayer(id));
            updateLayerTable();
        }
    }

    function applyLayerChanges() {
        if (window.cad) {
            window.cad.render();
        }
        closeLayerManager();
    }

    // إصلاح دالة updateLayerDropdown
    function updateLayerDropdown() {
        const select = document.getElementById('currentLayerSelect');
        if (!select || !window.cad) return;
        
        // التحقق من وجود دالة getCurrentLayerId
        if (typeof window.cad.getCurrentLayerId !== 'function') {
            console.warn('getCurrentLayerId not available yet');
            return;
        }
        
        select.innerHTML = '';
        
        const layers = window.cad.layerManager ? 
            Array.from(window.cad.layerManager.layers.values()) : 
            Array.from(window.cad.layers.values());
        
        layers.forEach(layer => {
            const option = document.createElement('option');
            option.value = layer.id;
            option.textContent = layer.name;
            if (layer.id === window.cad.getCurrentLayerId()) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    // تحديث دالة تهيئة updateLayersList
    document.addEventListener('DOMContentLoaded', function() {
        // انتظار تحميل CAD
        let checkInterval;
        let attempts = 0;
        
        function checkCADReady() {
            attempts++;
            
            if (window.cad && typeof window.cad.getCurrentLayerId === 'function') {
                clearInterval(checkInterval);
                
                // تحديث dropdown مرة واحدة عند البداية
                updateLayerDropdown();
                
                // إزالة الـ setInterval القديم وإضافة listener بدلاً منه
                const originalUpdateLayersList = window.cad.ui.updateLayersList;
                window.cad.ui.updateLayersList = function() {
                    originalUpdateLayersList.call(this);
                    // تحديث الـ dropdown فقط عند تغيير الطبقات
                    updateLayerDropdown();
                };
                
                console.log('✅ Layer dropdown initialized');
            } else if (attempts > 50) {
                clearInterval(checkInterval);
                console.warn('CAD loading timeout - layer dropdown may not work properly');
            }
        }
        
        checkInterval = setInterval(checkCADReady, 100);
    });
    
    // JavaScript لنظام أنواع وأوزان الخطوط
    // عرض لوحة أوزان الخطوط
    function showLineWeightPanel() {
        const panel = document.getElementById('lineWeightPanel');
        panel.style.display = 'flex';
        updateLineWeightPanel();
    }

    function closeLineWeightPanel() {
        document.getElementById('lineWeightPanel').style.display = 'none';
    }

    function updateLineWeightPanel() {
        const list = document.querySelector('.weight-list');
        list.innerHTML = '';
        
        if (window.cad && window.cad.linetypeManager) {
            const weights = window.cad.linetypeManager.getLineWeightsList();
            const currentWeight = window.cad.linetypeManager.currentLineWeight;
            
            weights.forEach(weight => {
                const item = document.createElement('div');
                item.className = 'weight-item';
                if (weight.value === currentWeight) {
                    item.classList.add('active');
                }
                
                // خط المعاينة
                const lineHeight = weight.mm === 0 ? 0.5 : 
                                  weight.mm < 0 ? 1 : 
                                  Math.min(weight.mm * 2, 6);
                
                item.innerHTML = `
                    <div class="weight-preview">
                        <div class="weight-line" style="height: ${lineHeight}px;"></div>
                    </div>
                    <div class="weight-label">${weight.label}</div>
                `;
                
                item.onclick = () => {
                    window.cad.setLineWeight(weight.value);
                    updateLineWeightPanel();
                };
                
                list.appendChild(item);
            });
        }
    }

    // Match Properties
    function matchProperties() {
        if (!window.cad) return;
        
        window.cad.updateStatus('Select source object');
        document.getElementById('matchPropertiesInfo').style.display = 'block';
        
        // تفعيل وضع اختيار الخصائص
        window.cad.pickingPointMode = 'matchProperties';
        window.cad.pickingPointCallback = (point) => {
            const shape = window.cad.getShapeAtPoint(point);
            if (shape) {
                // نسخ الخصائص
                const properties = {
                    color: shape.color,
                    lineType: shape.lineType || 'continuous',
                    lineWeight: shape.lineWeight || 0.25,
                    layerId: shape.layerId
                };
                
                // تطبيق الخصائص
                window.cad.currentColor = properties.color;
                window.cad.setLinetype(properties.lineType);
                window.cad.setLineWeight(properties.lineWeight);
                if (window.cad.layerManager) {
                    window.cad.layerManager.setCurrentLayer(properties.layerId);
                }
                
                document.getElementById('matchPropertiesInfo').style.display = 'none';
                window.cad.updateStatus('Properties matched');
            } else {
                window.cad.updateStatus('No object selected');
            }
            
            window.cad.pickingPointMode = null;
            window.cad.pickingPointCallback = null;
        };
    }

    // تحديث إعدادات عرض الأوزان
    function applyLineWeightSettings() {
        const displayWeights = document.getElementById('displayLineWeights').checked;
        const scale = parseFloat(document.getElementById('weightDisplayScale').value);
        
        // حفظ الإعدادات
        if (window.cad && window.cad.linetypeManager) {
            window.cad.linetypeManager.displayLineWeights = displayWeights;
            window.cad.linetypeManager.weightDisplayScale = scale;
        }
        
        if (window.cad) {
            window.cad.render();
        }
        closeLineWeightPanel();
    }

    // تحديث قيمة المقياس
    document.getElementById('weightDisplayScale').oninput = function() {
        document.getElementById('weightScaleValue').textContent = this.value;
    };
    </script>
    
</body>
</html>